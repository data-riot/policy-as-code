{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "TraceRecord",
  "description": "Immutable trace record for Policy as Code decisions",
  "version": "1.0.0",
  "type": "object",
  "properties": {
    "trace_id": {
      "type": "string",
      "format": "uuid",
      "description": "Unique trace identifier"
    },
    "df_id": {
      "type": "string",
      "pattern": "^[A-Z0-9._-]+$",
      "description": "Decision function identifier (e.g., MSSA.BENEFIT_23_4)"
    },
    "entry_id": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_-]+$",
      "description": "Unique entry identifier within trace"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Function version"
    },
    "df_hash": {
      "type": "string",
      "pattern": "^sha256:",
      "description": "SHA-256 hash of decision function"
    },
    "ts": {
      "type": "string",
      "format": "date-time",
      "description": "UTC timestamp of the event"
    },
    "input_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of input data"
    },
    "result_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of result data"
    },
    "execution_time_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Execution time in milliseconds"
    },
    "status": {
      "type": "string",
      "enum": [
        "OK",
        "ERROR"
      ],
      "description": "Execution status"
    },
    "error_message": {
      "type": "string",
      "description": "Error message if execution failed"
    },
    "caller_id": {
      "type": "string",
      "pattern": "^xroad:FI/ORG/",
      "description": "X-Road caller identifier (e.g., xroad:FI/ORG/1234567-8/SERVICE_ID)"
    },
    "cert_thumbprint": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 thumbprint of caller certificate"
    },
    "request_nonce": {
      "type": "string",
      "description": "Unique nonce for replay protection"
    },
    "input_ref": {
      "type": "string",
      "pattern": "^s3://",
      "description": "S3 reference to redacted input data"
    },
    "output": {
      "type": "object",
      "description": "Decision output data"
    },
    "chain_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of previous entry + current data"
    },
    "prev_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "Hash of previous entry in chain"
    },
    "genesis_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "Hash of genesis entry"
    },
    "legal_references": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "system": {
            "type": "string",
            "enum": [
              "finlex",
              "eur-lex",
              "custom"
            ]
          },
          "act_id": {
            "type": "string"
          },
          "section": {
            "type": "string"
          },
          "title": {
            "type": "string"
          },
          "uri": {
            "type": "string",
            "format": "uri"
          }
        },
        "required": [
          "system",
          "act_id",
          "section",
          "title",
          "uri"
        ]
      },
      "description": "Legal references used in decision"
    },
    "explain_data": {
      "type": "object",
      "description": "Explanation data (privacy-filtered)",
      "properties": {
        "reasoning_steps": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "applied_rules": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "legal_basis": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "audit_flags": {
      "type": "object",
      "properties": {
        "chain_verified": {
          "type": "boolean",
          "description": "Whether chain integrity is verified"
        },
        "signature_valid": {
          "type": "boolean",
          "description": "Whether signatures are valid"
        },
        "replay_detected": {
          "type": "boolean",
          "description": "Whether replay attack was detected"
        },
        "constraint_violations": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of constraint violations"
        }
      }
    },
    "metadata": {
      "type": "object",
      "properties": {
        "environment": {
          "type": "string",
          "enum": [
            "development",
            "staging",
            "production"
          ],
          "description": "Deployment environment"
        },
        "region": {
          "type": "string",
          "description": "Geographic region"
        },
        "tenant_id": {
          "type": "string",
          "description": "Multi-tenant identifier"
        },
        "retention_days": {
          "type": "integer",
          "minimum": 1,
          "description": "Data retention period in days"
        },
        "compliance_tags": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Compliance classification tags"
        }
      }
    }
  },
  "required": [
    "trace_id",
    "df_id",
    "version",
    "df_hash",
    "ts",
    "caller_id",
    "cert_thumbprint",
    "request_nonce",
    "input_ref",
    "output",
    "prev_hash",
    "chain_hash",
    "status"
  ],
  "additionalProperties": false
}
